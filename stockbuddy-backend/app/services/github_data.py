"""
台股資料服務 - 使用 GitHub 開源資料 (tw_stocker)
資料來源：https://github.com/voidful/tw_stocker
"""

import pandas as pd
import httpx
from datetime import datetime, timedelta
from typing import Optional, Dict, List, Any
from cachetools import TTLCache
import asyncio

# 快取設定
_cache = TTLCache(maxsize=200, ttl=300)  # 5分鐘快取


class GitHubStockService:
    """使用 GitHub tw_stocker 專案的資料服務"""
    
    BASE_URL = "https://raw.githubusercontent.com/voidful/tw_stocker/main/data"
    
    # 擴大股票池 - 台股熱門 + 各產業龍頭 + 潛力股（完整名稱對照）
    POPULAR_STOCKS = {
        # 半導體
        "2330": "台積電", "2454": "聯發科", "2303": "聯電", "3711": "日月光投控",
        "2379": "瑞昱", "3034": "聯詠", "6415": "矽力-KY", "3443": "創意",
        "5274": "信驊", "3661": "世芯-KY", "2408": "南亞科", "6488": "環球晶",
        
        # 電子代工
        "2317": "鴻海", "2382": "廣達", "2353": "宏碁", "2357": "華碩",
        "3231": "緯創", "2356": "英業達", "2324": "仁寶", "4938": "和碩",
        
        # AI / 伺服器
        "2345": "智邦", "3017": "奇鋐", "6669": "緯穎", "2395": "研華",
        "3036": "文曄", "6285": "啟碁", "3533": "嘉澤", "2439": "美律",
        
        # 網通 / IC 設計
        "2474": "可成", "3037": "欣興", "4966": "譜瑞-KY", "5269": "祥碩",
        "6446": "藥華藥", "3008": "大立光", "2207": "和泰車",
        
        # 金融
        "2881": "富邦金", "2882": "國泰金", "2891": "中信金", "2886": "兆豐金",
        "2884": "玉山金", "2885": "元大金", "2887": "台新金", "2880": "華南金",
        "2883": "開發金", "2890": "永豐金", "5880": "合庫金", "2892": "第一金",
        
        # 傳產龍頭
        "1301": "台塑", "1303": "南亞", "1326": "台化", "6505": "台塑化",
        "2002": "中鋼", "1402": "遠東新", "2912": "統一超", "1216": "統一",
        
        # 航運
        "2603": "長榮", "2609": "陽明", "2615": "萬海", "2618": "長榮航",
        
        # 電信 / 公用
        "2412": "中華電", "3045": "台灣大", "4904": "遠傳", "9933": "中鼎",
        
        # 生技醫療
        "4743": "合一", "6547": "高端疫苗", "1795": "美時", "6472": "保瑞",
        
        # 綠能 / 電動車
        "3481": "群創", "2409": "友達", "2308": "台達電", 
        "1513": "中興電", "1504": "東元", "2301": "光寶科",
        
        # 中小型潛力股
        "6531": "愛普", "3548": "兆利", "6153": "嘉聯益", "3005": "神基",
        "8046": "南電", "6202": "盛群", "2377": "微星", "6116": "彩晶",
        "3023": "信邦", "2344": "華邦電", "6239": "力成", "8299": "群聯",
        "3529": "力旺", "6257": "矽格", "2449": "京元電子", "3035": "智原",
        
        # 補充更多常見股票
        "2801": "彰銀", "2823": "中壽", "2834": "臺企銀", "2836": "高雄銀",
        "2838": "聯邦銀", "2845": "遠東銀", "2849": "安泰銀", "2850": "新產",
        "2851": "中再保", "2852": "第一保", "2855": "統一證", "2856": "元富證",
        "2867": "三商壽", "2888": "新光金", "2889": "國票金", "2897": "王道銀行",
        "1101": "台泥", "1102": "亞泥", "1103": "嘉泥", "1104": "環泥",
        "1108": "幸福", "1109": "信大", "1110": "東泥", "1201": "味全",
        "1203": "味王", "1210": "大成", "1213": "大飲", "1215": "卜蜂",
        "1217": "愛之味", "1218": "泰山", "1219": "福壽", "1220": "台榮",
        "1225": "福懋油", "1227": "佳格", "1229": "聯華", "1231": "聯華食",
        "1232": "大統益", "1233": "天仁", "1234": "黑松", "1235": "興泰",
        "1236": "宏亞", "1256": "鮮活果汁-KY", "1304": "台聚", "1305": "華夏",
        "1307": "三芳", "1308": "亞聚", "1309": "台達化", "1310": "台苯",
        "1312": "國喬", "1313": "聯成", "1314": "中石化", "1315": "達新",
        "1316": "上曜", "1319": "東陽", "1321": "大洋", "1323": "永裕",
        "1324": "地球", "1325": "恆大", "1326": "台化", "1409": "新纖",
        "1410": "南染", "1414": "東和", "1416": "廣豐", "1417": "嘉裕",
        "1418": "東華", "1419": "新紡", "1423": "利華", "1432": "大魯閣",
        "1434": "福懋", "1435": "中福", "1436": "華友聯", "1437": "勤益控",
        "1438": "裕豐", "1439": "中和", "1440": "南紡", "1441": "大東",
        "1442": "名軒", "1443": "立益", "1444": "力麗", "1445": "大宇",
        "1446": "宏和", "1447": "力鵬", "1449": "佳和", "1451": "年興",
        "1452": "宏益", "1453": "大將", "1454": "台富", "1455": "集盛",
        "1456": "怡華", "1457": "宜進", "1459": "聯發", "1460": "宏遠",
        "1463": "強盛", "1464": "得力", "1465": "偉全", "1466": "聚隆",
        "1467": "南緯", "1468": "昶和", "1469": "理隆", "1470": "大統新創",
        "1471": "首利", "1472": "三洋紡", "1473": "台南", "1474": "弘裕",
        "1475": "本盟", "1476": "儒鴻", "1477": "聚陽", "1503": "士電",
        "1506": "正道", "1512": "瑞利", "1514": "亞力", "1515": "力山",
        "1516": "川飛", "1517": "利奇", "1519": "華城", "1521": "大億",
        "1522": "堤維西", "1524": "耿鼎", "1525": "江申", "1526": "日馳",
        "1527": "鑽全", "1528": "恩德", "1529": "樂士", "1530": "亞崴",
        "1531": "高林股", "1532": "勤美", "1533": "車王電", "1535": "中宇",
        "1536": "和大", "1537": "廣隆", "1538": "正峰", "1539": "巨庭",
        "1540": "喬福", "1541": "錩泰", "1558": "伸興", "1560": "中砂",
        "1565": "精華", "1568": "倉佑", "1582": "信錦", "1583": "程泰",
        "1584": "精剛", "1586": "和勤", "1587": "吉茂", "1589": "永冠-KY",
        "1590": "亞德客-KY", "1597": "直得", "1598": "岱宇", "1599": "宏佳騰",
        "1603": "華電", "1604": "聲寶", "1605": "華新", "1608": "華榮",
        "1609": "大亞", "1611": "中電", "1612": "宏泰", "1614": "三洋電",
        "1615": "大山", "1616": "億泰", "1617": "榮星", "1618": "合機",
        "1626": "艾美特-KY", "1701": "中化", "1702": "南僑", "1707": "葡萄王",
        "1708": "東鹼", "1709": "和益", "1710": "東聯", "1711": "永光",
        "1712": "興農", "1713": "國化", "1714": "和桐", "1717": "長興",
        "1718": "中纖", "1720": "生達", "1721": "三晃", "1722": "台肥",
        "1723": "中碳", "1725": "元禎", "1726": "永記", "1727": "中華化",
        "1730": "花仙子", "1731": "美吾華", "1732": "毛寶", "1733": "五鼎",
        "1734": "杏輝", "1735": "日勝化", "1736": "喬山", "1737": "臺鹽",
        "1760": "寶齡富錦", "1762": "中化生", "1773": "勝一", "1776": "展宇",
        "1783": "和康生", "1784": "訊聯", "1785": "光洋科", "1786": "科妍",
        "1789": "神隆", "1795": "美時", "1796": "金穎生技", "1802": "台玻",
        "1805": "寶徠", "1806": "冠軍", "1808": "潤隆", "1809": "中釉",
        "1810": "和成", "1813": "寶利徠", "1815": "富喬", "1817": "凱撒衛",
        "1903": "士紙", "1904": "正隆", "1905": "華紙", "1906": "寶隆",
        "1907": "永豐餘", "1909": "榮成", "2006": "東和鋼鐵", "2007": "燁興",
        "2008": "高興昌", "2009": "第一銅", "2010": "春源", "2012": "春雨",
        "2013": "中鋼構", "2014": "中鴻", "2015": "豐興", "2017": "官田鋼",
        "2020": "美亞", "2022": "聚亨", "2023": "燁輝", "2024": "志聯",
        "2025": "千興", "2027": "大成鋼", "2028": "威致", "2029": "盛餘",
        "2030": "彰源", "2031": "新光鋼", "2032": "新鋼", "2033": "佳大",
        "2034": "允強", "2038": "海光", "2049": "上銀", "2059": "川湖",
        "2101": "南港", "2102": "泰豐", "2103": "台橡", "2104": "國際中橡",
        "2105": "正新", "2106": "建大", "2107": "厚生", "2109": "華豐",
        "2114": "鑫永銓", "2115": "六暉-KY", "2201": "裕隆", "2204": "中華",
        "2206": "三陽工業", "2211": "長榮鋼", "2227": "裕日車", "2228": "劍麟",
        "2231": "為升", "2233": "宇隆", "2236": "百達-KY", "2239": "英利-KY",
        "2241": "艾姆勒", "2243": "宏旭-KY", "2247": "汎德永業", "2250": "統一實",
        "2301": "光寶科", "2302": "麗正", "2305": "全友", "2312": "金寶",
        "2313": "華通", "2314": "台揚", "2316": "楠梓電", "2321": "東訊",
        "2323": "中環", "2324": "仁寶", "2327": "國巨", "2328": "廣宇",
        "2329": "華泰", "2331": "精英", "2332": "友訊", "2337": "旺宏",
        "2338": "光罩", "2340": "光磊", "2342": "茂矽", "2344": "華邦電",
        "2347": "聯強", "2348": "海悅", "2349": "錸德", "2351": "順德",
        "2352": "佳世達", "2354": "鴻準", "2355": "敬鵬", "2356": "英業達",
        "2358": "廷鑫", "2359": "所羅門", "2360": "致茂", "2362": "藍天",
        "2363": "矽統", "2364": "倫飛", "2365": "昆盈", "2367": "燿華",
        "2368": "金像電", "2369": "菱生", "2371": "大同", "2373": "震旦行",
        "2374": "佳能", "2375": "智寶", "2376": "技嘉", "2377": "微星",
        "2380": "虹光", "2383": "台光電", "2384": "勝華", "2385": "群光",
        "2387": "精元", "2388": "威盛", "2390": "云辰", "2392": "正崴",
        "2393": "億光", "2395": "研華", "2397": "友通", "2399": "映泰",
        "2401": "凌陽", "2402": "毅嘉", "2404": "漢唐", "2405": "浩鑫",
        "2406": "國碩", "2409": "友達", "2413": "環科", "2414": "精技",
        "2415": "錩新", "2417": "圓剛", "2419": "仲琦", "2420": "新巨",
        "2421": "建準", "2423": "固緯", "2424": "隴華", "2425": "承啟",
        "2426": "鼎元", "2427": "三商電", "2428": "興勤", "2429": "銘旺科",
        "2430": "燦坤", "2431": "聯昌", "2433": "互盛電", "2434": "統懋",
        "2436": "偉詮電", "2438": "翔耀", "2440": "太空梭", "2441": "超豐",
        "2442": "新美齊", "2443": "億麗", "2444": "兆勁", "2448": "晶電",
        "2449": "京元電子", "2450": "神腦", "2451": "創見", "2453": "凌群",
        "2455": "全新", "2456": "奇力新", "2457": "飛宏", "2458": "義隆",
        "2459": "敦吉", "2460": "建通", "2461": "光群雷", "2462": "良得電",
        "2464": "盟立", "2465": "麗臺", "2466": "冠西電", "2467": "志聖",
        "2468": "華經", "2471": "資通", "2472": "立隆電", "2473": "思達斯",
        "2476": "鉅祥", "2477": "美隆電", "2478": "大毅", "2480": "敦陽科",
        "2481": "強茂", "2482": "連宇", "2483": "百容", "2484": "希華",
        "2485": "兆赫", "2486": "一詮", "2488": "漢平", "2489": "瑞軒",
        "2491": "吉祥全", "2492": "華新科", "2493": "揚博", "2495": "普安",
        "2496": "卓越", "2497": "怡利電", "2498": "宏達電", "2499": "東貝",
        "2501": "國建", "2504": "國產", "2505": "國揚", "2506": "太設",
        "2509": "全坤建", "2511": "太子", "2514": "龍邦", "2515": "中工",
        "2516": "新建", "2520": "冠德", "2524": "京城", "2527": "宏璟",
        "2528": "皇普", "2530": "華建", "2534": "宏盛", "2535": "達欣工",
        "2536": "宏普", "2537": "聯上發", "2538": "基泰", "2539": "櫻花建",
        "2540": "愛山林", "2542": "興富發", "2543": "皇昌", "2545": "皇翔",
        "2546": "根基", "2547": "日勝生", "2548": "華固", "2597": "潤弘",
        "2601": "益航", "2603": "長榮", "2604": "新象建設", "2605": "新興",
        "2606": "裕民", "2607": "榮運", "2608": "嘉里大榮", "2609": "陽明",
        "2610": "華航", "2611": "志信", "2612": "中航", "2613": "中櫃",
        "2614": "東森", "2615": "萬海", "2616": "山隆", "2617": "台航",
        "2618": "長榮航", "2630": "亞航", "2633": "台灣高鐵", "2634": "漢翔",
        "2636": "台驊投控", "2637": "慧洋-KY", "2642": "宅配通", "2701": "萬企",
        "2702": "華園", "2704": "國賓", "2705": "六福", "2706": "第一店",
        "2707": "晶華", "2712": "遠雄來", "2722": "夏都", "2723": "美食-KY",
        "2727": "王品", "2731": "雄獅", "2739": "寒舍", "2748": "雲品",
        "2753": "八方雲集", "2801": "彰銀", "2809": "京城銀", "2812": "台中銀",
        "2816": "旺旺保", "2820": "華票", "2832": "台產", "2834": "臺企銀",
        "2836": "高雄銀", "2838": "聯邦銀", "2845": "遠東銀", "2849": "安泰銀",
        "2850": "新產", "2851": "中再保", "2852": "第一保", "2855": "統一證",
        "2856": "元富證", "2867": "三商壽", "2880": "華南金", "2881": "富邦金",
        "2882": "國泰金", "2883": "開發金", "2884": "玉山金", "2885": "元大金",
        "2886": "兆豐金", "2887": "台新金", "2888": "新光金", "2889": "國票金",
        "2890": "永豐金", "2891": "中信金", "2892": "第一金", "2897": "王道銀行",
        "2901": "欣欣", "2903": "遠百", "2904": "匯僑", "2905": "三商",
        "2906": "高林", "2908": "特力", "2910": "統領", "2911": "麗嬰房",
        "2912": "統一超", "2913": "農林", "2915": "潤泰全", "2923": "鼎固-KY",
        "2929": "淘帝-KY", "2936": "客思達-KY", "2937": "集雅社", "3002": "歐格",
        "3003": "健和興", "3004": "豐達科", "3005": "神基", "3006": "晶豪科",
        "3010": "華立", "3011": "今皓", "3013": "晟銘電", "3014": "聯陽",
        "3015": "全漢", "3016": "嘉晶", "3017": "奇鋐", "3018": "同開",
        "3019": "亞光", "3021": "鴻名", "3022": "威強電", "3023": "信邦",
        "3024": "憶聲", "3025": "星通", "3026": "禾伸堂", "3027": "盛達",
        "3028": "增你強", "3029": "零壹", "3030": "德律", "3031": "佰鴻",
        "3032": "偉訓", "3033": "威健", "3034": "聯詠", "3035": "智原",
        "3036": "文曄", "3037": "欣興", "3038": "全台", "3040": "遠見",
        "3041": "揚智", "3042": "晶技", "3043": "科風", "3044": "健鼎",
        "3045": "台灣大", "3046": "建碁", "3047": "訊舟", "3048": "益登",
        "3049": "和鑫", "3050": "鈺德", "3051": "力特", "3052": "夆典",
        "3053": "嘉晶電", "3054": "立萬利", "3055": "蔚華科", "3056": "總太",
        "3057": "喬鼎", "3058": "立德", "3059": "華晶科", "3060": "銘異",
        "3062": "建漢", "3078": "僑威", "3089": "遠昇", "3090": "日電貿",
        "3092": "鴻碩", "3094": "聯傑", "3105": "穩懋", "3118": "進階",
        "3128": "昇銳", "3130": "一零四", "3131": "弘塑", "3149": "正達",
        "3152": "璟德", "3162": "精確", "3163": "波若威", "3164": "景岳",
        "3167": "大量", "3176": "基亞", "3189": "景碩", "3209": "全科",
        "3211": "順達", "3217": "優群", "3221": "台嘉碩", "3224": "三顧",
        "3227": "原相", "3229": "晟鑫", "3230": "錦明", "3231": "緯創",
        "3234": "光環", "3257": "虹冠電", "3260": "威剛", "3266": "昇陽",
        "3268": "海德威", "3293": "鑫科", "3296": "勝德", "3299": "帛漢",
        "3303": "岱稜", "3305": "昇貿", "3306": "鼎天", "3308": "聯德",
        "3310": "佳穎", "3311": "閎暉", "3312": "弘憶股", "3313": "斐成",
        "3322": "建舜電", "3324": "雙鴻", "3325": "旭品", "3338": "泰碩",
        "3339": "泰谷", "3346": "麗清", "3350": "華鋐", "3354": "律勝",
        "3356": "奇偶", "3360": "尚立", "3372": "典範", "3374": "精材",
        "3376": "新日興", "3380": "明泰", "3383": "新世紀", "3388": "崇越電",
        "3390": "旭軟", "3406": "玉晶光", "3413": "京鼎", "3416": "融程電",
        "3419": "譁裕", "3426": "台興", "3432": "台端", "3437": "榮創",
        "3438": "類比科", "3443": "創意", "3444": "利機", "3450": "聯鈞",
        "3454": "晶睿", "3455": "由田", "3481": "群創", "3490": "單井",
        "3494": "誠研", "3498": "陽程", "3499": "環天科", "3501": "維熹",
        "3504": "揚明光", "3510": "力旺", "3511": "矽瑪", "3515": "華擎",
        "3516": "亞帝歐", "3518": "柏騰", "3519": "綠能", "3522": "御頂",
        "3523": "迎輝", "3524": "欣銓", "3527": "聚積", "3528": "安馳",
        "3529": "力旺", "3530": "晶相光", "3531": "先益", "3532": "台勝科",
        "3533": "嘉澤", "3535": "晶彩科", "3536": "誠創", "3545": "敦泰",
        "3546": "宇峻", "3548": "兆利", "3550": "聯穎", "3551": "世禾",
        "3556": "禾瑞亞", "3557": "嘉威", "3559": "全台晶像", "3561": "昇陽光電",
        "3563": "牧德", "3576": "新日光", "3579": "尚志", "3580": "友威科",
        "3581": "博磊", "3582": "凌耘", "3583": "辛耘", "3584": "介面",
        "3587": "閎康", "3588": "通嘉", "3591": "艾笛森", "3592": "瑞鼎",
        "3593": "力銘", "3594": "磐儀", "3596": "智易", "3598": "奕力",
        "3599": "旭曜", "3605": "宏致", "3607": "谷崧", "3608": "典範",
        "3609": "東林", "3611": "鼎翰", "3615": "安可", "3617": "碩天",
        "3622": "洋華", "3625": "西勝", "3630": "新鉅科", "3642": "駿熠電",
        "3645": "達邁", "3646": "艾恩特", "3653": "健策", "3654": "陽程科技",
        "3661": "世芯-KY", "3665": "貿聯-KY", "3669": "圓展", "3672": "康聯訊",
        "3673": "TPK-KY", "3675": "德微", "3679": "新至陞", "3682": "亞太電",
        "3684": "榮昌", "3686": "達能", "3687": "歐買尬", "3689": "湧德",
        "3691": "碩禾", "3693": "營邦", "3694": "海華", "3697": "晨品",
        "3698": "隆達", "3701": "大眾控", "3702": "大聯大", "3703": "欣陸",
        "3704": "合勤控", "3705": "永信", "3706": "神達", "3707": "漢磊",
        "3708": "上緯投控", "3710": "連展投控", "3711": "日月光投控",
        "3712": "永崴投控", "3714": "富采", "4104": "佳醫", "4108": "懷特",
        "4119": "旭富", "4123": "晟德", "4126": "太醫", "4128": "中天",
        "4129": "聯合", "4130": "健亞", "4133": "亞諾法", "4137": "麗豐-KY",
        "4138": "曜亞", "4141": "龍燈-KY", "4142": "國光生", "4144": "康聯-KY",
        "4147": "中裕", "4148": "全宇生技-KY", "4151": "明躍-KY", "4152": "台微體",
        "4155": "訊映", "4157": "太景*-KY", "4160": "創源", "4161": "聿新科",
        "4162": "智擎", "4163": "鑽石生技", "4164": "承業醫", "4167": "松瑞藥",
        "4168": "醣聯", "4171": "瑞基", "4174": "浩鼎", "4180": "安成藥",
        "4188": "安克生醫", "4190": "佐登-KY", "4192": "杏國", "4195": "基米",
        "4198": "環瑞醫", "4205": "中華食", "4304": "勝昱", "4306": "炎洲",
        "4401": "東隆興", "4402": "福大", "4414": "如興", "4415": "台原藥",
        "4416": "三圓", "4417": "金洲", "4419": "元勝", "4426": "利勤",
        "4430": "耀億", "4432": "銘旺實", "4433": "興采", "4438": "廣越",
        "4439": "冠星-KY", "4440": "宇加", "4502": "源恆", "4503": "金雨",
        "4506": "崇友", "4510": "高鋒", "4513": "福裕", "4523": "永彰",
        "4526": "東台", "4527": "方土霖", "4528": "江興鍛", "4529": "晉泰",
        "4530": "宏易", "4532": "瑞智", "4533": "協易機", "4534": "慶騰",
        "4535": "至興", "4536": "拓凱", "4538": "大詠城", "4540": "全球傳動",
        "4541": "晟田", "4542": "科嶠", "4543": "萬在", "4545": "銘鈺",
        "4549": "桓達", "4550": "長佳", "4551": "智伸科", "4552": "力達-KY",
        "4554": "橙的", "4555": "氣立", "4556": "旭然", "4557": "永新-KY",
        "4560": "強信-KY", "4561": "健椿", "4564": "元翎", "4566": "時碩工業",
        "4568": "科際精密", "4571": "鈞寶", "4572": "駐龍", "4576": "大銀微系統",
        "4581": "光隆精密-KY", "4583": "台榮產", "4711": "永純", "4720": "德淵",
        "4721": "美琪瑪", "4722": "國精化", "4726": "永昕", "4728": "雙美",
        "4729": "熒茂", "4735": "豪展", "4736": "泰博", "4737": "華廣",
        "4739": "康普", "4743": "合一", "4744": "皇將", "4746": "台耀",
        "4747": "強生", "4755": "三福化", "4760": "勤凱", "4763": "材料-KY",
        "4764": "雙鍵", "4766": "南寶", "4768": "晶呈科", "4770": "上品",
        "4804": "大略-KY", "4806": "昇華", "4807": "日成-KY", "4904": "遠傳",
        "4906": "正文", "4908": "前鼎", "4912": "聯德控股-KY", "4915": "致伸",
        "4916": "事欣科", "4919": "新唐", "4923": "力士", "4927": "泰鼎-KY",
        "4930": "燦星網", "4931": "新盛力", "4934": "太極", "4935": "茂林-KY",
        "4938": "和碩", "4942": "嘉彰", "4943": "康控-KY", "4944": "兆遠",
        "4950": "牧東", "4952": "凌通", "4956": "光鋐", "4958": "臻鼎-KY",
        "4960": "奇美材", "4961": "天鈺", "4966": "譜瑞-KY", "4967": "十銓",
        "4968": "立積", "4971": "IET-KY", "4974": "亞泰", "4976": "佳凌",
        "4977": "眾達-KY", "4984": "科納-KY", "4999": "鑫禾", "5007": "三星",
        "5009": "榮剛", "5011": "久陽", "5014": "建錩", "5203": "訊連",
        "5209": "新鼎", "5210": "寶碩", "5211": "蒙恬", "5215": "科嘉-KY",
        "5222": "全訊", "5225": "東科-KY", "5227": "立凱-KY", "5234": "達興材料",
        "5243": "乙盛-KY", "5244": "弘凱", "5258": "虹堡", "5259": "清惠-KY",
        "5263": "智崴", "5264": "鎧勝-KY", "5269": "祥碩", "5274": "信驊",
        "5276": "達輝-KY", "5281": "大峽谷-KY", "5283": "禾聯碩", "5284": "jpp-KY",
        "5285": "界霖", "5287": "數字", "5288": "豐祥-KY", "5289": "宜鼎",
        "5291": "邑昇", "5292": "華懋", "5299": "杰力", "5301": "寶得利",
        "5302": "太欣", "5304": "鼎創達", "5305": "敦南", "5306": "桂盟",
        "5309": "系統電", "5310": "天剛", "5312": "寶島科", "5314": "世紀",
        "5317": "凱美", "5324": "士開", "5340": "建榮", "5344": "立衛",
        "5345": "天揚", "5347": "世界", "5348": "系通", "5351": "鈺創",
        "5353": "台林", "5355": "佳總", "5356": "協益", "5364": "力麒",
        "5371": "中光電", "5381": "合正", "5384": "捷元", "5388": "中磊",
        "5392": "應華", "5403": "中菲", "5410": "國眾", "5425": "台半",
        "5426": "振發", "5434": "崇越", "5438": "東友", "5439": "高技",
        "5443": "均豪", "5450": "寶聯通", "5455": "昇益", "5457": "宣德",
        "5468": "凱鈺", "5469": "瀚宇博", "5471": "松翰", "5474": "聰泰",
        "5475": "德宏", "5478": "智冠", "5480": "統盟", "5481": "鍾南",
        "5483": "中美晶", "5484": "慧友", "5489": "彩富", "5490": "同亨",
        "5493": "三聯", "5498": "凱崴", "5508": "永信建", "5511": "德昌",
        "5512": "力麒", "5515": "建國", "5519": "隆大", "5520": "力泰",
        "5521": "工信", "5522": "遠雄", "5525": "順天", "5529": "志嘉",
        "5531": "鄉林", "5533": "皇鼎", "5534": "長虹", "5538": "東明-KY",
        "5546": "永固-KY", "5601": "台聯櫃", "5603": "陸海", "5604": "中連貨",
        "5607": "遠雄港", "5608": "四維航", "5609": "中菲行", "5701": "劍湖山",
        "5704": "老爺知", "5706": "鳳凰", "5871": "中租-KY", "5876": "上海商銀",
        "5878": "台名", "5880": "合庫金", "5903": "全家", "5904": "寶雅",
        "5905": "南仁湖", "5906": "台南-KY", "5907": "大洋-KY", "6005": "群益證",
        "6016": "康和證", "6020": "大展證", "6021": "大慶證", "6023": "元大期",
        "6024": "群益期", "6108": "競國", "6112": "聚碩", "6113": "亞矽",
        "6115": "鎰勝", "6116": "彩晶", "6117": "迎廣", "6118": "建達",
        "6120": "達運", "6121": "新普", "6122": "擎邦", "6123": "上奇",
        "6125": "廣運", "6126": "信音", "6127": "九豪", "6128": "上福",
        "6129": "普誠", "6130": "星寶", "6131": "悠克", "6133": "金橋",
        "6134": "萬旭", "6136": "富爾特", "6138": "茂達", "6139": "亞翔",
        "6141": "柏承", "6142": "友勁", "6143": "振曜", "6145": "勁永",
        "6146": "耕興", "6147": "頎邦", "6148": "驊宏", "6150": "撼訊",
        "6151": "晉倫", "6152": "百一", "6153": "嘉聯益", "6154": "順發",
        "6155": "鈞寶", "6156": "松上", "6158": "禾昌", "6160": "欣技",
        "6161": "捷波", "6163": "華電網", "6164": "華興", "6165": "捷泰",
        "6166": "凌華", "6167": "久正", "6168": "宏齊", "6169": "昱泉",
        "6170": "統振", "6171": "亞銳士", "6172": "互億", "6173": "信昌電",
        "6174": "安碁", "6175": "立敦", "6176": "瑞儀", "6177": "達麗",
        "6179": "亞通", "6180": "橘子", "6182": "合晶", "6183": "關貿",
        "6184": "大豐電", "6185": "幃翔", "6186": "新潤", "6187": "萬潤",
        "6188": "廣明", "6189": "豐藝", "6190": "萬泰科", "6191": "精成科",
        "6192": "巨路", "6194": "育富", "6195": "詩肯", "6196": "帆宣",
        "6197": "佳必琪", "6198": "凌泰", "6199": "天品", "6201": "亞弘電",
        "6202": "盛群", "6203": "海韻電", "6206": "飛捷", "6207": "雷科",
        "6208": "日揚", "6209": "今國光", "6210": "慶生", "6211": "精博",
        "6213": "聯茂", "6214": "精誠", "6215": "和椿", "6216": "居易",
        "6217": "中探針", "6218": "豪勉", "6219": "富旺", "6220": "岳豐",
        "6221": "晉泰", "6223": "旺矽", "6224": "聚鼎", "6225": "天瀚",
        "6226": "光鼎", "6227": "茂綸", "6229": "研通", "6230": "尼得科超眾",
        "6231": "系微", "6233": "旺玖", "6234": "高僑", "6235": "華孚",
        "6239": "力成", "6240": "松崗", "6241": "易通展", "6242": "立康",
        "6243": "迅杰", "6244": "茂迪", "6245": "立端", "6246": "臺龍",
        "6257": "矽格", "6259": "百徽", "6261": "久元", "6263": "普萊德",
        "6264": "富裔", "6265": "方土霖", "6266": "泰詠", "6269": "台郡",
        "6270": "倍微", "6271": "同欣電", "6274": "台燿", "6275": "元山",
        "6276": "安鈦克", "6277": "宏正", "6278": "台表科", "6279": "胡連",
        "6281": "全國電", "6282": "康舒", "6283": "淳安", "6284": "佳邦",
        "6285": "啟碁", "6286": "立翔", "6287": "元隆電", "6288": "聯嘉",
        "6289": "華上", "6290": "良維", "6291": "沛亨-KY", "6292": "迅德",
        "6405": "悅城", "6409": "旭隼", "6411": "晶焱", "6412": "群電",
        "6414": "樺漢", "6415": "矽力-KY", "6416": "瑞祺電通", "6417": "韋僑",
        "6419": "京晨科", "6426": "統新", "6431": "光麗-KY", "6438": "迅得",
        "6442": "光聖", "6443": "元晶", "6446": "藥華藥", "6449": "鈺邦",
        "6451": "訊芯-KY", "6456": "GIS-KY", "6457": "紘康", "6462": "神盾",
        "6464": "台數科", "6465": "威潤", "6469": "大樹", "6470": "宇智",
        "6472": "保瑞", "6477": "安集", "6482": "弘煜科", "6485": "點序",
        "6486": "互動", "6488": "環球晶", "6491": "晶碩", "6492": "生華科",
        "6494": "九齊", "6496": "科懋", "6504": "南六", "6505": "台塑化",
        "6506": "雙邦", "6508": "惠光", "6509": "聚和", "6510": "精測",
        "6512": "啟發電", "6515": "穎崴", "6523": "達爾膚", "6525": "捷敏-KY",
        "6526": "達發", "6527": "明達醫", "6530": "創威", "6531": "愛普",
        "6533": "晶心科", "6535": "順藥", "6538": "倉和", "6541": "泰福-KY",
        "6542": "隆中", "6547": "高端疫苗", "6548": "長科*", "6550": "北極星藥業-KY",
        "6552": "易華電", "6558": "興能高", "6560": "欣普羅", "6568": "宏觀",
        "6573": "虹揚-KY", "6576": "逸達", "6579": "研揚", "6581": "鋼聯",
        "6582": "申豐", "6588": "東典", "6589": "台康生技", "6592": "和潤企業",
        "6593": "台灣銘板", "6598": "ABC-KY", "6605": "帝寶", "6609": "瀧澤科",
        "6612": "奈米醫材", "6615": "慧智", "6616": "特昇-KY", "6625": "必應",
        "6631": "晉弘", "6641": "基士德-KY", "6643": "M31", "6651": "鉅邁",
        "6654": "天正國際", "6655": "科定", "6657": "華安", "6658": "聯策",
        "6664": "群翊", "6666": "羅麗芬-KY", "6667": "信紘科", "6668": "中揚光",
        "6669": "緯穎", "6670": "復盛應用", "6671": "三能-KY", "6672": "騰輝電子-KY",
        "6674": "鋐寶科技", "6679": "鈺太", "6683": "雍智", "6689": "伊雲谷",
        "6690": "台中精機", "6691": "洋基工程", "6695": "芯鼎", "6698": "旭暉應材",
        "6699": "台灣虎航", "6702": "興航", "6706": "惠特", "6712": "長聖",
        "6715": "嘉基", "6719": "力智", "6733": "博晟生醫", "6741": "91APP*-KY",
        "6742": "澤米", "6743": "安集科技", "6752": "永冠-KY", "6753": "龍德造船",
        "6754": "匯僑設計", "6755": "福生", "6756": "威鋒電子", "6757": "台灣虎航",
        "6770": "力積電", "6776": "展碁國際", "6781": "AES-KY", "6782": "視陽",
        "6788": "華景電", "6789": "采鈺", "6790": "永豐實", "6796": "晉泰科技",
        "6799": "來頡", "6803": "崑鼎", "6805": "富世達", "6806": "森崴能源",
        "6807": "峰源-KY", "6830": "汎銓", "6834": "天二", "6835": "圖靈",
        "6837": "瑞興", "6838": "台詠", "6841": "雷爵", "6846": "普禾",
        "6855": "科彥", "6863": "永道-KY", "6869": "雲豹能源", "6871": "北星-KY",
        "6873": "泓德能源-KY", "6877": "欣銓科技", "6878": "台科電", "6879": "追覓科",
        "6883": "茂丞", "6890": "台恩半導體", "6895": "宏碁資訊", "6898": "采威國際",
        "6901": "鑽石投資", "6903": "雲高-KY", "8011": "台通", "8016": "矽創",
        "8021": "尖點", "8024": "佑華", "8028": "昇陽半導體", "8033": "雷虎",
        "8034": "榮群", "8038": "長園科", "8039": "台虹", "8040": "九暘",
        "8042": "金山電", "8044": "網家", "8046": "南電", "8050": "廣積",
        "8054": "安國", "8059": "凱碩", "8064": "東捷", "8066": "來思達",
        "8067": "志旭", "8069": "元太", "8070": "長華", "8071": "能率",
        "8072": "陞泰", "8074": "鉅橡", "8076": "伍豐", "8078": "華寶",
        "8081": "致新", "8083": "瑞穎", "8084": "巨虹", "8086": "宏捷科",
        "8088": "品安", "8089": "康全電訊", "8092": "建暐", "8096": "擎亞",
        "8099": "大世科", "8101": "華冠", "8103": "瀚荃", "8104": "錸寶",
        "8105": "凌巨", "8107": "大億科", "8109": "博大", "8110": "華東",
        "8111": "立碁", "8112": "至上", "8114": "振樺電", "8121": "越峰",
        "8131": "福懋科", "8150": "南茂", "8163": "達方", "8182": "加高",
        "8201": "無敵", "8210": "勤誠", "8213": "志超", "8215": "明基材",
        "8222": "寶一", "8227": "巨有", "8240": "華宏", "8249": "菱光",
        "8255": "朋程", "8261": "富鼎", "8271": "宇瞻", "8277": "商億-KY",
        "8279": "生展", "8281": "聯華氣體", "8284": "維詮", "8289": "泰藝",
        "8290": "鈦昇", "8291": "尖水", "8294": "鏡感", "8299": "群聯",
        "8341": "日友", "8342": "益詮", "8349": "恒耀", "8354": "冠好",
        "8358": "金居", "8359": "立肯", "8367": "建新國際", "8374": "羅升",
        "8383": "千附", "8390": "金益鼎", "8401": "白紗科技", "8404": "百和興業-KY",
        "8406": "金可-KY", "8409": "商之器", "8410": "森田", "8411": "福貞-KY",
        "8415": "大國鎂", "8416": "實威", "8420": "明揚", "8421": "旭源",
        "8422": "可寧衛", "8426": "紅木-KY", "8427": "基勝-KY", "8429": "金麗-KY",
        "8430": "潤惠-KY", "8431": "匯鑽-KY", "8432": "東生華", "8433": "弘帆",
        "8434": "茂鴻電子", "8435": "鉅明", "8436": "大江", "8437": "大地-KY",
        "8438": "昶昕", "8440": "綠電", "8442": "威宏-KY", "8443": "阿瘦",
        "8446": "華研", "8450": "霹靂", "8454": "富邦媒", "8462": "柏文",
        "8463": "潤泰材", "8464": "億豐", "8466": "美吉吉-KY", "8467": "波力-KY",
        "8473": "山林水", "8476": "台境", "8477": "創業家", "8478": "東哥遊艇",
        "8480": "泰昇-KY", "8481": "政伸", "8482": "商億-KY", "8488": "吉源-KY",
        "8497": "捷智商訊", "8499": "鼎炫-KY", "8916": "光隆", "8926": "台汽電",
        "8927": "北基", "8928": "鉅明", "8929": "富堡", "8930": "青雲",
        "8931": "大汽電", "8932": "宏大", "8933": "愛地雅", "8934": "衡平",
        "8935": "邦泰", "8936": "國統", "8937": "合騏", "8940": "新天地",
        "8941": "關中", "8942": "森鉅", "8996": "高力", "9802": "鈺齊-KY",
        "9902": "台火", "9903": "茂榮", "9904": "寶成", "9905": "大華",
        "9906": "欣巴巴", "9907": "統一實", "9908": "大台北", "9910": "豐泰",
        "9911": "櫻花", "9912": "偉聯", "9914": "美利達", "9917": "中保科",
        "9918": "欣天然", "9919": "康那香", "9921": "巨大", "9924": "福興",
        "9925": "新保", "9926": "新海", "9927": "泰銘", "9928": "中視",
        "9929": "秋雨", "9930": "中聯資源", "9931": "欣高", "9933": "中鼎",
        "9934": "成霖", "9935": "慶豐富", "9937": "全國", "9938": "百和",
        "9939": "宏全", "9940": "信義", "9941": "裕融", "9942": "茂順",
        "9943": "好樂迪", "9944": "新麗", "9945": "潤泰新", "9946": "三發地產",
        "9955": "佳龍", "9958": "世紀鋼",
        
        # ETF (用於大盤參考)
        "0050": "元大台灣50", "0056": "元大高股息", "00878": "國泰永續高股息",
    }

    def __init__(self):
        self.client = httpx.AsyncClient(timeout=30.0)

    async def close(self):
        await self.client.aclose()

    async def get_stock_data(self, stock_id: str) -> Optional[pd.DataFrame]:
        """從 GitHub 取得股票歷史資料"""
        cache_key = f"github_data_{stock_id}"
        if cache_key in _cache:
            return _cache[cache_key]

        try:
            url = f"{self.BASE_URL}/{stock_id}.csv"
            response = await self.client.get(url)
            
            if response.status_code != 200:
                # 404 錯誤是正常的（不是所有股票都有 GitHub 資料），不需要輸出
                return None
            
            from io import StringIO
            df = pd.read_csv(StringIO(response.text))
            
            _cache[cache_key] = df
            return df

        except Exception as e:
            # 只記錄非預期的錯誤
            # print(f"取得 {stock_id} 資料時發生錯誤: {e}")
            return None

    async def get_stock_info(self, stock_id: str) -> Optional[Dict[str, Any]]:
        """取得個股即時資訊"""
        df = await self.get_stock_data(stock_id)
        
        if df is None or df.empty:
            return None
        
        # 標準化欄位名稱
        df.columns = df.columns.str.lower()
        
        latest = df.iloc[-1]
        prev = df.iloc[-2] if len(df) > 1 else latest
        
        close_price = float(latest['close'])
        prev_close = float(prev['close'])
        change = close_price - prev_close
        change_pct = (change / prev_close * 100) if prev_close > 0 else 0
        
        date_str = str(latest.get('datetime', ''))[:10] if 'datetime' in df.columns else datetime.now().strftime("%Y-%m-%d")
        
        return {
            "stock_id": stock_id,
            "name": self.POPULAR_STOCKS.get(stock_id, stock_id),
            "date": date_str,
            "open": round(float(latest['open']), 2),
            "high": round(float(latest['high']), 2),
            "low": round(float(latest['low']), 2),
            "close": round(close_price, 2),
            "volume": int(latest['volume']),
            "change": round(change, 2),
            "change_percent": round(change_pct, 2),
        }

    async def get_stock_history(self, stock_id: str, days: int = 90) -> List[Dict[str, Any]]:
        """取得個股歷史K線資料（已聚合成日K）"""
        df = await self.get_stock_data(stock_id)
        
        if df is None or df.empty:
            return []
        
        try:
            # 標準化欄位名稱
            df.columns = df.columns.str.lower()
            
            # 解析日期
            if 'datetime' in df.columns:
                df['datetime'] = pd.to_datetime(df['datetime'], utc=True)
                df['date_only'] = df['datetime'].dt.date
            else:
                # 如果沒有日期欄位，創建假日期
                df['date_only'] = pd.date_range(end=datetime.now(), periods=len(df)).date
            
            # 聚合成日K
            daily = df.groupby('date_only').agg({
                'open': 'first',
                'high': 'max',
                'low': 'min',
                'close': 'last',
                'volume': 'sum',
            }).reset_index()
            
            # 取最近 N 天
            daily = daily.tail(days)
            
            result = []
            prev_close = None
            
            for _, row in daily.iterrows():
                close = float(row['close'])
                change = close - prev_close if prev_close else 0
                
                result.append({
                    "date": str(row['date_only']),
                    "open": round(float(row['open']), 2),
                    "high": round(float(row['high']), 2),
                    "low": round(float(row['low']), 2),
                    "close": round(close, 2),
                    "volume": int(row['volume']),
                    "change": round(change, 2),
                })
                
                prev_close = close
            
            return result
            
        except Exception as e:
            print(f"處理 {stock_id} 歷史資料時發生錯誤: {e}")
            return []

    async def get_market_index(self) -> Optional[Dict[str, Any]]:
        """取得大盤指數"""
        info = await self.get_stock_info("0050")
        
        if info:
            return {
                "name": "加權指數(估)",
                "symbol": "^TWII",
                "date": info["date"],
                "value": round(info["close"] * 130, 2),
                "change": round(info["change"] * 130, 2),
                "change_percent": info["change_percent"],
                "volume": info["volume"],
            }
        return None

    async def search_stock(self, query: str) -> List[Dict[str, Any]]:
        """搜尋股票"""
        results = []
        for stock_id, name in self.POPULAR_STOCKS.items():
            if query.lower() in stock_id.lower() or query in name:
                results.append({"stock_id": stock_id, "name": name})
        return results


github_stock_service = GitHubStockService()


class SmartStockService:
    """智能股票資料服務 - 自動選擇最佳資料源"""
    
    POPULAR_STOCKS = GitHubStockService.POPULAR_STOCKS
    
    @classmethod
    async def get_stock_info(cls, stock_id: str) -> Optional[Dict[str, Any]]:
        """取得個股資訊"""
        
        # 方案 1：yfinance
        try:
            from .stock_data import StockDataService
            result = await StockDataService.get_stock_info(stock_id)
            if result:
                return result
        except Exception:
            pass  # yfinance 失敗是正常的，靜默處理
        
        # 方案 2：GitHub
        try:
            result = await github_stock_service.get_stock_info(stock_id)
            if result:
                return result
        except Exception:
            pass  # GitHub 失敗是正常的，靜默處理
        
        # 方案 3：Mock
        try:
            from .mock_data import MockStockDataService
            return await MockStockDataService.get_stock_info(stock_id)
        except:
            pass
        
        return None

    @classmethod
    async def get_stock_history(cls, stock_id: str, months: int = 3) -> List[Dict[str, Any]]:
        """取得歷史資料"""
        days = months * 30
        
        # 方案 1：yfinance
        try:
            from .stock_data import StockDataService
            result = await StockDataService.get_stock_history(stock_id, months)
            if result and len(result) > 30:
                return result
        except Exception:
            pass  # yfinance 歷史資料失敗是正常的，靜默處理
        
        # 方案 2：GitHub
        try:
            result = await github_stock_service.get_stock_history(stock_id, days)
            if result and len(result) > 30:
                return result
        except Exception:
            pass  # GitHub 歷史資料失敗是正常的，靜默處理
        
        # 方案 3：Mock
        try:
            from .mock_data import MockStockDataService
            return await MockStockDataService.get_stock_history(stock_id, months)
        except:
            pass
        
        return []

    @classmethod
    async def get_market_index(cls) -> Optional[Dict[str, Any]]:
        """取得大盤指數"""
        
        # 方案 1：yfinance
        try:
            from .stock_data import StockDataService
            result = await StockDataService.get_market_index()
            if result:
                return result
        except:
            pass
        
        # 方案 2：GitHub
        try:
            result = await github_stock_service.get_market_index()
            if result:
                return result
        except:
            pass
        
        # 方案 3：Mock
        try:
            from .mock_data import MockStockDataService
            return await MockStockDataService.get_market_index()
        except:
            pass
        
        return None

    @classmethod
    async def search_stock(cls, query: str) -> List[Dict[str, Any]]:
        return await github_stock_service.search_stock(query)

    @classmethod
    async def get_multiple_stocks(cls, stock_ids: List[str]) -> Dict[str, Dict[str, Any]]:
        results = {}
        for sid in stock_ids:
            info = await cls.get_stock_info(sid)
            if info:
                results[sid] = info
        return results
