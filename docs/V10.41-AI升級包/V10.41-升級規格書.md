# StockBuddy V10.41 AI 升級規格書

> 版本: V10.41
> 代號: AI Evolution
> 日期: 2026-01-15
> 目標: 引入國際前沿 AI 技術，提升預測準確率與用戶體驗

---

## 執行摘要

本次升級將 StockBuddy 從傳統 ML (XGBoost) 架構升級至現代 AI 架構，
引入 **SHAP 解釋性**、**FinBERT 語義情緒分析**、**TFT 時間序列預測**
和 **PPO 強化學習**。

| 階段 | 時程 | 項目 | 預期效益 |
|------|------|------|----------|
| Phase 1 | Week 1-2 | SHAP + FinBERT | 情緒準確率 +25% |
| Phase 2 | Week 3-6 | Transformer TFT | 預測準確率 +5-8% |
| Phase 3 | Week 7-12 | 強化學習 PPO | 動態策略優化 |

---

## Phase 1: SHAP + FinBERT (Week 1-2)

### 1.1 SHAP 解釋性 AI

**目標:** 讓用戶理解 AI 推薦的原因

**新增檔案:**
- `app/services/shap_explainer.py`

**修改檔案:**
- `app/services/ml_predictor.py` - 新增 `explain_prediction()` 方法
- `app/routers/ml_routes.py` - 新增 `/api/stocks/ml/explain/{stock_id}` 端點

**API 規格:**

```
GET /api/stocks/ml/explain/{stock_id}

Response:
{
    "success": true,
    "stock_id": "2330",
    "prediction": "up",
    "probability": 0.72,
    "explanation": {
        "base_value": 0.5,
        "predicted_value": 0.72,
        "top_features": [
            {"feature": "rsi_14", "value": 28, "contribution": +0.08, "direction": "positive"},
            {"feature": "foreign_net_ratio", "value": 0.15, "contribution": +0.05, "direction": "positive"},
            {"feature": "ma_alignment", "value": 1, "contribution": +0.04, "direction": "positive"},
            {"feature": "volume_ratio_20d", "value": 1.8, "contribution": +0.03, "direction": "positive"},
            {"feature": "price_vs_ma20", "value": 2.5, "contribution": +0.02, "direction": "positive"}
        ]
    }
}
```

**驗收標準:**
- [ ] API 回傳正確的 SHAP 貢獻度
- [ ] 前端能顯示 SHAP 瀑布圖
- [ ] 響應時間 < 500ms

---

### 1.2 FinBERT 情緒分析

**目標:** 用語義理解取代關鍵字匹配

**新增檔案:**
- `app/services/finbert_sentiment.py`

**修改檔案:**
- `app/services/news_service.py` - 整合 FinBERT
- `app/services/enhanced_ai_analysis.py` - 使用新情緒分析

**模型選擇:**
- 英文: `ProsusAI/finbert`
- 中文: `hw2942/chinese-finbert-sentiment` 或 `uer/roberta-base-finetuned-chinanews-chinese`

**API 規格:**

```
POST /api/stocks/sentiment/analyze

Request:
{
    "text": "台積電營收創新高，法人看好後市表現",
    "language": "zh"  // "en" or "zh"
}

Response:
{
    "success": true,
    "sentiment": {
        "label": "positive",
        "score": 0.92,
        "probabilities": {
            "positive": 0.92,
            "neutral": 0.06,
            "negative": 0.02
        }
    },
    "model": "chinese-finbert",
    "processing_time_ms": 45
}
```

**驗收標準:**
- [ ] 正確分類正面/負面/中性情緒
- [ ] 中文新聞準確率 > 80%
- [ ] 支援批次分析 (最多 10 條)

---

## Phase 2: Transformer TFT (Week 3-6)

### 2.1 Temporal Fusion Transformer

**目標:** 引入時間序列深度學習

**新增檔案:**
- `app/services/tft_predictor.py`
- `scripts/train_tft_model.py`
- `app/models/tft/` (模型存放目錄)

**輸入規格:**
- 60 天歷史 K 線
- 每日特徵: OHLCV + 技術指標 + 籌碼

**輸出規格:**
- 未來 5 天報酬分佈
- 預測區間 (上下界)
- 注意力權重 (可解釋性)

**API 規格:**

```
GET /api/stocks/ml/tft-predict/{stock_id}

Response:
{
    "success": true,
    "stock_id": "2330",
    "predictions": {
        "day_1": {"return": 0.8, "lower": -0.5, "upper": 2.1},
        "day_2": {"return": 1.2, "lower": -0.3, "upper": 2.7},
        "day_3": {"return": 1.5, "lower": 0.0, "upper": 3.0},
        "day_4": {"return": 1.8, "lower": 0.2, "upper": 3.4},
        "day_5": {"return": 2.0, "lower": 0.5, "upper": 3.5}
    },
    "attention": {
        "important_days": [55, 58, 59],  // 模型關注的歷史日期
        "important_features": ["volume", "rsi", "foreign_net"]
    },
    "model_version": "tft_v1_20260115"
}
```

**訓練需求:**
- GPU: RTX 3060 以上 (8GB VRAM)
- 訓練數據: 至少 500 支股票 x 2 年歷史
- 訓練時間: 約 4-8 小時

**驗收標準:**
- [ ] TFT 預測 RMSE 優於 XGBoost
- [ ] 注意力權重可視覺化
- [ ] 支援 GPU 加速推論

---

### 2.2 Ensemble 集成

**目標:** 結合 XGBoost + TFT 的優勢

**修改檔案:**
- `app/services/ml_predictor.py` - 新增 ensemble 方法

**集成策略:**
```python
# 動態權重 (根據近期準確率調整)
xgb_weight = 0.4 + 0.2 * (xgb_recent_accuracy - 0.5)
tft_weight = 1.0 - xgb_weight

final_prediction = xgb_weight * xgb_prob + tft_weight * tft_prob
```

---

## Phase 3: 強化學習 PPO (Week 7-12)

### 3.1 PPO 交易代理

**目標:** 動態倉位配置優化

**新增檔案:**
- `app/services/rl_agent.py`
- `app/services/trading_env.py` (Gym 環境)
- `scripts/train_rl_agent.py`

**環境定義:**
```python
State = [
    market_features,  # 市場特徵 (20維)
    portfolio_state,  # 持倉狀態 (10維)
    cash_ratio,       # 現金比例
    risk_budget       # 風險預算
]

Action = [
    position_change   # 倉位變化 (-1 到 +1)
]

Reward = sharpe_ratio  # 風險調整後收益
```

**API 規格:**

```
POST /api/stocks/rl/suggest

Request:
{
    "stock_id": "2330",
    "current_position": 0.3,  // 目前持倉比例
    "cash_available": 100000,
    "risk_tolerance": "medium"
}

Response:
{
    "success": true,
    "suggestion": {
        "action": "increase",
        "target_position": 0.45,
        "confidence": 0.78,
        "reasoning": [
            "RSI 處於超賣區間",
            "外資連續 3 日買超",
            "風險預算充足"
        ]
    }
}
```

**驗收標準:**
- [ ] 回測 Sharpe Ratio > 1.0
- [ ] 最大回撤 < 15%
- [ ] 決策可解釋

---

## 技術需求

### 後端依賴 (requirements.txt 新增)

```
# Phase 1: SHAP + FinBERT
shap>=0.44.0
transformers>=4.36.0
torch>=2.1.0
sentencepiece>=0.1.99

# Phase 2: TFT
pytorch-forecasting>=1.0.0
pytorch-lightning>=2.1.0

# Phase 3: RL
stable-baselines3>=2.2.0
gymnasium>=0.29.0
```

### 硬體需求

| 階段 | CPU | GPU | RAM |
|------|-----|-----|-----|
| Phase 1 | 4 核 | 無需 | 8GB |
| Phase 2 | 8 核 | RTX 3060+ | 16GB |
| Phase 3 | 8 核 | RTX 3060+ | 16GB |

### 前端新增元件

1. `SHAPWaterfall.jsx` - SHAP 瀑布圖視覺化
2. `SentimentBadge.jsx` - 情緒標籤顯示
3. `TFTPredictionChart.jsx` - TFT 預測走勢圖
4. `RLSuggestionPanel.jsx` - RL 建議面板

---

## 檔案清單

### 新增檔案

```
stockbuddy-backend/
├── app/services/
│   ├── shap_explainer.py      ← SHAP 解釋器
│   ├── finbert_sentiment.py   ← FinBERT 情緒
│   ├── tft_predictor.py       ← TFT 預測器
│   ├── rl_agent.py            ← RL 代理
│   └── trading_env.py         ← 交易環境
├── app/models/
│   ├── tft/                   ← TFT 模型目錄
│   └── rl/                    ← RL 模型目錄
└── scripts/
    ├── train_tft_model.py     ← TFT 訓練腳本
    └── train_rl_agent.py      ← RL 訓練腳本

stockbuddy-frontend/
└── src/components/
    ├── SHAPWaterfall.jsx      ← SHAP 視覺化
    ├── SentimentBadge.jsx     ← 情緒標籤
    ├── TFTPredictionChart.jsx ← TFT 圖表
    └── RLSuggestionPanel.jsx  ← RL 建議
```

### 修改檔案

```
stockbuddy-backend/
├── app/services/
│   ├── ml_predictor.py        ← 整合 SHAP + ensemble
│   ├── news_service.py        ← 整合 FinBERT
│   └── enhanced_ai_analysis.py← 使用新情緒
├── app/routers/
│   └── ml_routes.py           ← 新增 API 端點
└── requirements.txt           ← 新增依賴
```

---

## 驗收測試

### Phase 1 驗收

```bash
# 測試 SHAP
curl http://localhost:8000/api/stocks/ml/explain/2330

# 測試 FinBERT
curl -X POST http://localhost:8000/api/stocks/sentiment/analyze \
  -H "Content-Type: application/json" \
  -d '{"text": "台積電法說會釋出樂觀展望", "language": "zh"}'
```

### Phase 2 驗收

```bash
# 測試 TFT 預測
curl http://localhost:8000/api/stocks/ml/tft-predict/2330

# 比較準確率
python scripts/compare_models.py --models xgboost,tft --period 30d
```

### Phase 3 驗收

```bash
# 測試 RL 建議
curl -X POST http://localhost:8000/api/stocks/rl/suggest \
  -H "Content-Type: application/json" \
  -d '{"stock_id": "2330", "current_position": 0.3}'

# 回測驗證
python scripts/backtest_rl.py --period 1y
```

---

## 時程規劃

```
2026-01
├── W3: Phase 1 開發 (SHAP + FinBERT)
├── W4: Phase 1 測試與修正
2026-02
├── W1-W2: Phase 2 開發 (TFT)
├── W3: Phase 2 訓練與調參
├── W4: Phase 2 測試與整合
2026-03
├── W1-W2: Phase 3 開發 (RL)
├── W3-W4: Phase 3 訓練與回測
2026-04
├── W1: 全面整合測試
├── W2: V10.41 發布
```

---

## 聯絡資訊

如有疑問，請參考：
- 戰略報告: `V10.41-AI升級包/AI戰略報告.md`
- 程式碼模板: `V10.41-AI升級包/後端程式碼/`
- 測試腳本: `V10.41-AI升級包/測試腳本/`

---

*規格書版本: 1.0*
*最後更新: 2026-01-15*
