# StockBuddy V10.41 部署問題分析報告

> 日期：2026-01-15
> 版本：V10.41
> 用途：記錄部署過程中遇到的問題與解決方案，作為日後參考

---

## 問題一：為何更新後需要重新部署這麼多步驟？

### 背景說明

之前的版本（V10.35.2）在 GitHub `main` 分支上有以下結構：
```
stockbuddy/
├── stockbuddy-frontend/   ← 直接在根目錄
└── stockbuddy-backend/    ← 直接在根目錄
```

本地開發版本（V10.41 在 `master` 分支）有不同結構：
```
stockbuddy/
└── data/股票程式開發/
    ├── stockbuddy-frontend/   ← 嵌套在子目錄
    └── stockbuddy-backend/    ← 嵌套在子目錄
```

### 問題根源

| 項目 | 原本 (main) | 本地 (master) | 衝突 |
|------|------------|---------------|------|
| 前端路徑 | `stockbuddy-frontend` | `data/股票程式開發/stockbuddy-frontend` | 不同 |
| 後端路徑 | `stockbuddy-backend` | `data/股票程式開發/stockbuddy-backend` | 不同 |
| Git 歷史 | 獨立初始化 | 獨立初始化 | 不相關歷史 |
| Vercel 設定 | Root: `stockbuddy-frontend` | 需要改: `data/...` | 需更新 |
| Render 設定 | Root: `stockbuddy-backend` | 需要改: `data/...` | 需更新 |

### 為何需要這麼多步驟？

1. **Git 不相關歷史合併** - `main` 和 `master` 有不同的初始 commit，需要 `--allow-unrelated-histories`
2. **目錄結構不同** - 部署平台的 Root Directory 設定需要更新
3. **CORS 設定** - 後端 `ALLOWED_ORIGINS` 需要包含新的前端網址
4. **資料庫檔案鎖定** - 本地運行的後端鎖定了 `stockbuddy.db`，阻礙 git 操作

### 最終解決方案

選擇了 **方案 B：重整目錄結構**，把程式碼移到根目錄：
```
stockbuddy/
├── stockbuddy-frontend/   ← 現在在根目錄
├── stockbuddy-backend/    ← 現在在根目錄
└── docs/
```

### 教訓與預防措施

| 教訓 | 預防措施 |
|------|---------|
| 本地開發目錄結構應與部署結構一致 | 專案初始化時就確定最終結構 |
| 多分支開發要定期同步 | 每次重大更新後立即 commit 並 push |
| 部署設定要版本控制 | 在 repo 中保存 `vercel.json`、`render.yaml` |
| 環境變數要文件化 | 維護 `.env.example` 和部署文件 |

---

## 問題二：ML 模型訓練顯示 "連線失敗: Failed to fetch"

### 問題根源：API_BASE 硬編碼

**MLPanel.jsx (第 21 行) - 問題代碼**：
```javascript
const API_BASE = 'http://localhost:8000';  // ❌ 硬編碼
```

**config.js (第 9 行) - 正確做法**：
```javascript
export const API_BASE = import.meta.env.VITE_API_BASE || 'http://localhost:8000';  // ✅ 環境變數
```

### 問題分析

| 環境 | MLPanel 呼叫的 URL | 實際後端 URL | 結果 |
|------|-------------------|-------------|------|
| 本地開發 | `http://localhost:8000` | `http://localhost:8000` | ✅ 正常 |
| 生產環境 | `http://localhost:8000` | `https://stockbuddy-api.onrender.com` | ❌ 失敗 |

### 網路請求流程

```
生產環境前端 (https://stockbuddy-ebon.vercel.app)
  ↓
MLPanel.jsx: fetch('http://localhost:8000/api/stocks/ml/train')  ← 錯誤！
  ↓
瀏覽器嘗試連接 localhost:8000
  ↓
連線失敗 → "Failed to fetch"
```

### 修復方案

**修改 MLPanel.jsx**：
```javascript
// 第 21 行，從：
const API_BASE = 'http://localhost:8000';

// 改為：
import { API_BASE } from '../config';
```

### 修復後的效果

```
生產環境前端 (https://stockbuddy-ebon.vercel.app)
  ↓
MLPanel.jsx: fetch('https://stockbuddy-api.onrender.com/api/stocks/ml/train')  ← 正確！
  ↓
連接 Render 後端
  ↓
ML 訓練成功 ✅
```

---

## 部署檢查清單

### 環境變數

| 平台 | 變數名稱 | 值 |
|------|---------|-----|
| Vercel | `VITE_API_BASE` | `https://stockbuddy-api.onrender.com` |
| Render | `ALLOWED_ORIGINS` | `http://localhost:3000,http://localhost:5173,https://stockbuddy-ebon.vercel.app` |

### Root Directory 設定

| 平台 | Root Directory |
|------|---------------|
| Vercel | `stockbuddy-frontend` |
| Render | `stockbuddy-backend` |

---

## 常見錯誤與解決方案

| 錯誤訊息 | 原因 | 解決方案 |
|---------|------|---------|
| `Failed to fetch` | API_BASE 硬編碼為 localhost | 使用 config.js 的 API_BASE |
| `CORS error` | 後端未允許前端網址 | 在 Render 設定 ALLOWED_ORIGINS |
| `Build Failed: Root Directory does not exist` | 目錄結構不匹配 | 更新 Vercel/Render 的 Root Directory |
| `unrelated histories` | Git 分支歷史不同 | 使用 `--allow-unrelated-histories` |

---

## 相關檔案

| 檔案 | 用途 |
|------|------|
| `stockbuddy-frontend/src/config.js` | API 基礎地址配置 |
| `stockbuddy-frontend/src/components/MLPanel.jsx` | ML 管理面板 |
| `stockbuddy-backend/app/main.py` | 後端主程式 (CORS 設定) |
| `.env.production` | 生產環境變數 |

---

*報告生成時間：2026-01-15*
*作者：Claude Opus 4.5*
